# Web Application Penetration Testing Workflow
# Focused on web application security assessment
# Supports optional whitebox analysis when --source is provided

name: web_application_pentest
description: Web application security testing workflow with optional source code analysis

# Whitebox phase - runs only if --source parameter is provided
whitebox:
  enabled_if_source: true
  tools:
    - semgrep
    - trivy
    - gitleaks
    - trufflehog
  extract_attack_surface: true
  ai_analysis: true

steps:
  - name: http_discovery
    type: tool
    tool: httpx
    objective: "Discover web services and fingerprint technologies"
    parameters:
      tech_detect: true

  # Run ZAP early to build a rich endpoint set for all downstream tools.
  # When whitebox is available, seed URLs from source analysis accelerate
  # discovery. Without source, ZAP spiders from the target URL alone.
  - name: zap_early_scan
    type: tool
    tool: zap
    objective: "Spider the target early to build a rich URL set for downstream tools"
    condition: zap_available
    parameters:
      use_whitebox_seeds: true
      spider: true
      ajax_spider: true
    dependencies:
      - http_discovery

  - name: port_scan
    type: tool
    tool: nmap
    objective: "Identify additional services and exposed ports"
    parameters:
      ports: "80,443,8080,8443,3000,5000,8000"
      scan_type: "-sV -sC"

  - name: waf_detection
    type: tool
    tool: wafw00f
    objective: "Detect common WAF/CDN protections"
    parameters:
      find_all: true
    dependencies:
      - http_discovery

  - name: tls_headers_scan
    type: tool
    tool: sslyze
    objective: "Assess TLS posture and HTTP security headers"
    parameters:
      regular: false
    dependencies:
      - http_discovery

  - name: ssl_tls_scan
    type: tool
    tool: testssl
    objective: "Comprehensive SSL/TLS testing for 15+ vulnerability types"
    parameters:
      severity: "LOW"
    dependencies:
      - http_discovery

  - name: security_headers
    type: tool
    tool: headers
    objective: "Check common HTTP security headers"
    parameters:
      follow_redirects: true
      timeout: 10
    dependencies:
      - http_discovery

  - name: tech_fingerprint
    type: tool
    tool: whatweb
    objective: "Identify web technologies and frameworks"
    parameters: {}
    dependencies:
      - http_discovery

  - name: cms_detection
    type: tool
    tool: cmseek
    objective: "Detect CMS and common misconfigurations"
    parameters:
      batch: true
      random_agent: true
    dependencies:
      - http_discovery

  - name: crawl
    type: tool
    tool: katana
    objective: "Crawl the site to enumerate endpoints, enriched by ZAP early scan URLs when available"
    parameters: {}
    dependencies:
      - http_discovery
      - zap_early_scan

  - name: historical_urls
    type: tool
    tool: waybackurls
    objective: "Collect historical URLs for hidden endpoints"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: js_url_extraction
    type: tool
    tool: subjs
    objective: "Extract JavaScript URLs from discovered pages"
    parameters: {}
    dependencies:
      - crawl

  - name: js_endpoint_extraction
    type: tool
    tool: xnlinkfinder
    objective: "Extract endpoints from JavaScript"
    parameters: {}
    dependencies:
      - crawl

  - name: client_side_linkfinder
    type: tool
    tool: linkfinder
    objective: "Parse client-side JavaScript for endpoints"
    parameters: {}
    dependencies:
      - crawl

  - name: retire_scan
    type: tool
    tool: retire
    objective: "Detect vulnerable client-side libraries"
    parameters: {}
    dependencies:
      - crawl

  - name: feroxbuster_discovery
    type: tool
    tool: feroxbuster
    objective: "Recursive content discovery for web and API paths"
    parameters:
      api_mode: true
    dependencies:
      - crawl

  - name: param_discovery
    type: tool
    tool: paramspider
    objective: "Find parameterized URLs from ZAP seed URLs"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: param_probe
    type: tool
    tool: arjun
    objective: "Probe for hidden parameters using ZAP seed URLs"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: commix_scan
    type: tool
    tool: commix
    objective: "Scan for command injection vulnerabilities"
    parameters:
      level: 2
    dependencies:
      - param_discovery

  - name: nikto_baseline_scan
    type: tool
    tool: nikto
    objective: "Run baseline web vulnerability scan using ZAP seed URLs"
    parameters:
      tuning: "x"
      timeout: 10
    dependencies:
      - zap_early_scan

  - name: vulnerability_scan
    type: tool
    tool: nuclei
    objective: "Scan for web vulnerabilities"
    parameters:
      severity: ["critical", "high"]
      tool_timeout: 900
    dependencies:
      - crawl

  - name: api_schema_scan
    type: tool
    tool: schemathesis
    objective: "Fuzz OpenAPI/Swagger endpoints discovered via ZAP seed URLs"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: graphql_scan
    type: tool
    tool: graphql-cop
    objective: "Probe GraphQL endpoints discovered via ZAP seed URLs"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: xss_scan
    type: tool
    tool: dalfox
    objective: "Focused XSS scan on discovered URLs"
    parameters:
      deep: true
    dependencies:
      - crawl

  - name: xss_scan_xsstrike
    type: tool
    tool: xsstrike
    objective: "Additional XSS detection with payload analysis"
    parameters:
      crawl: true
    dependencies:
      - crawl

  - name: csrf_scan
    type: tool
    tool: csrf-tester
    objective: "Check for CSRF vulnerabilities"
    parameters: {}
    dependencies:
      - crawl

  - name: upload_scan
    type: tool
    tool: upload-scanner
    objective: "Test for insecure file upload handling"
    parameters: {}
    dependencies:
      - crawl

  - name: cookie_security
    type: tool
    tool: cookie-analyzer
    objective: "Analyze cookie security flags on ZAP-discovered URLs"
    parameters:
      timeout: 10
    dependencies:
      - zap_early_scan

  - name: cors_scan
    type: tool
    tool: cors-scanner
    objective: "Test for CORS misconfigurations on ZAP-discovered URLs"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: ssrf_scan
    type: tool
    tool: ssrf-scanner
    objective: "Test for SSRF vulnerabilities"
    parameters: {}
    dependencies:
      - param_discovery

  - name: xxe_scan
    type: tool
    tool: xxe-scanner
    objective: "Test for XXE injection on ZAP-discovered URLs"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: deserialization_scan
    type: tool
    tool: deserialization-scanner
    objective: "Detect insecure deserialization on ZAP-discovered URLs"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: auth_scan
    type: tool
    tool: auth-scanner
    objective: "Test for authentication bypass and session flaws on ZAP-discovered URLs"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: idor_scan
    type: tool
    tool: idor-scanner
    objective: "Test for IDOR and authorization bypass on ZAP-discovered URLs"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: error_detection
    type: tool
    tool: error-detector
    objective: "Detect information disclosure through error messages on ZAP-discovered URLs"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: auth_bruteforce
    type: tool
    tool: hydra
    objective: "Credential guessing for exposed services discovered via ZAP"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: jwt_analysis
    type: tool
    tool: jwt_tool
    objective: "Analyze JWT handling and common weaknesses on ZAP-discovered URLs"
    parameters: {}
    dependencies:
      - zap_early_scan

  - name: analyze_web_vulns
    type: analysis
    agent: analyst
    objective: "Analyze web-specific vulnerabilities"
  
  - name: false_positive_check
    type: analysis
    agent: analyst
    objective: "Filter false positives"
  
  - name: generate_web_report
    type: report
    agent: reporter
    format: html

settings:
  max_parallel_tools: 3
  require_confirmation: false
  save_intermediate: true
