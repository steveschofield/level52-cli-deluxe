# Network Infrastructure Penetration Testing Workflow
# Network-level security assessment

name: network_pentest
description: Network infrastructure security testing

steps:
  - name: host_discovery
    type: tool
    tool: masscan
    objective: "Fast common-port discovery for CIDR/range targets"
    condition: target_is_network
    parameters:
      # Common ports + network/device mgmt + VPN + voice signaling services
      ports: "21,22,23,25,53,67,68,69,80,81,88,110,111,123,135,137,138,139,143,161,162,179,389,427,443,445,465,500,514,515,520,548,554,587,623,631,636,691,993,995,1080,1194,1433,1434,1494,1521,1701,1723,1812,1813,1883,2000,2427,2727,3306,3389,3478,4443,4500,4786,5000,5060,5061,51820,5432,5555,5900,8080,8081,8443"
      rate: 5000

  - name: fast_host_sweep
    type: tool
    tool: masscan
    objective: "Full port discovery for single IP targets"
    condition: target_is_single_ip
    parameters:
      ports: "1-65535"
      rate: 5000

  - name: ids_ips_evasion_scan
    type: tool
    tool: nmap
    objective: "IDS/IPS evasion scan on discovered TCP ports"
    parameters:
      ports_from_context: true
      scan_type: "-sS -Pn -f -D RND:5 --scan-delay 50ms --max-rate 200"
      timing: "T2"

  - name: full_tcp_port_scan
    type: tool
    tool: nmap
    objective: "TCP validation scan on ports discovered by masscan"
    parameters:
      ports_from_context: true
      scan_type: "-sS"
      timing: "T3"

  - name: popular_udp_scan
    type: tool
    tool: nmap
    objective: "Popular UDP ports scan"
    parameters:
      ports: "53,67,68,69,88,111,123,135,137,138,161,162,389,445,500,514,520,623,1194,1701,1812,1813,1900,2049,3478,4500,4789,5004,5005,5060,5061,5353,11211,1434,3389"
      scan_type: "-sU"
      timing: "T3"

  - name: udp_service_probe
    type: tool
    tool: nmap
    objective: "UDP service probing on common ports"
    parameters:
      ports: "53,67,68,69,88,111,123,135,137,138,161,162,389,445,500,514,520,623,1194,1701,1812,1813,1900,2049,3478,4500,4789,5004,5005,5060,5061,5353,11211,1434,3389"
      scan_type: "-sU -sV --version-intensity 0"
      timing: "T3"

  - name: sctp_scan
    type: tool
    tool: nmap
    objective: "Quick SCTP scan"
    parameters:
      scan_type: "-sY --top-ports 50"
      timing: "T3"

  - name: service_detection
    type: tool
    tool: nmap
    objective: "Deep service and version detection"
    parameters:
      scan_type: "-sV -sC"
      ports_from_context: true
    dependencies:
      - host_discovery
      - fast_host_sweep
      - ids_ips_evasion_scan
      - full_tcp_port_scan
      - popular_udp_scan
      - udp_service_probe
      - sctp_scan

  - name: smb_enumeration
    type: tool
    tool: nmap
    objective: "SMB enumeration (shares/users/version)"
    parameters:
      ports_from_context: true
      ports_filter: "445"
      scan_type: "--script smb-os-discovery,smb-enum-shares,smb-enum-users"
    dependencies:
      - service_detection

  - name: smb_null_session_check
    type: tool
    tool: enum4linux-ng
    objective: "Check for SMB null session and enumerate"
    parameters:
      # CRITICAL: No username or password parameters for null session
      scan_type: "-A {target}"
    dependencies:
      - service_detection

  - name: share_enumeration
    type: multi_tool
    objective: "Enumerate SMB and NFS shares"
    tools:
      - tool: smbclient
      - tool: showmount
    dependencies:
      - service_detection

  - name: smb_deep_enumeration
    type: tool
    tool: enum4linux-ng
    objective: "Deep SMB enumeration with extended checks"
    parameters:
      # CRITICAL: No username or password for null session
      scan_type: "-A {target}"
      output_format: "-oY /tmp/enum4linux_{target}.yaml"
    dependencies:
      - smb_null_session_check
    condition: |
      # Only run if null session is possible
      smb_null_session_check.success == true

  # Alternative: If you need authenticated enumeration, create a separate step
  - name: smb_authenticated_enumeration
    type: tool
    tool: enum4linux-ng
    objective: "SMB enumeration with credentials"
    enabled: false  # Disabled by default, enable only when credentials are available
    parameters:
      username: "{provided_username}"  # Only use if credentials are explicitly provided
      password: "{provided_password}"  # Only use if credentials are explicitly provided
      scan_type: "-A {target}"
    dependencies:
      - smb_null_session_check
    condition: |
      # Only run if null session failed and credentials are provided
      smb_null_session_check.null_session_failed == true and 
      credentials.provided == true

  - name: snmp_enumeration
    type: tool
    tool: nmap
    objective: "SNMP enumeration"
    parameters:
      ports_from_context: true
      ports_filter: "161"
      scan_type: "--script snmp-info,snmp-interfaces,snmp-sysdescr"
    dependencies:
      - service_detection

  - name: snmp_bruteforce
    type: multi_tool
    objective: "SNMP community discovery and walk"
    tools:
      - tool: onesixtyone
      - tool: snmpwalk
    dependencies:
      - service_detection

  - name: ldap_enumeration
    type: tool
    tool: nmap
    objective: "LDAP enumeration"
    parameters:
      ports_from_context: true
      ports_filter: "389,636"
      scan_type: "--script ldap-rootdse,ldap-search"
    dependencies:
      - service_detection

  - name: rdp_enumeration
    type: tool
    tool: nmap
    objective: "RDP enumeration"
    parameters:
      ports_from_context: true
      ports_filter: "3389"
      scan_type: "--script rdp-enum-encryption,rdp-ntlm-info"
    dependencies:
      - service_detection

  - name: ftp_checks
    type: tool
    tool: nmap
    objective: "FTP service checks (anon, banner, methods)"
    parameters:
      ports_from_context: true
      ports_filter: "21"
      scan_type: "--script ftp-anon,ftp-syst,ftp-bounce"
    dependencies:
      - service_detection

  - name: smtp_checks
    type: tool
    tool: nmap
    objective: "SMTP service checks (banner, commands, users)"
    parameters:
      ports_from_context: true
      ports_filter: "25,465,587"
      scan_type: "--script smtp-commands,smtp-enum-users,smtp-open-relay"
    dependencies:
      - service_detection

  - name: http_checks
    type: tool
    tool: nmap
    objective: "HTTP service checks (methods, headers, enum)"
    parameters:
      ports_from_context: true
      ports_filter: "80,443,8080,8443,8000,8008,8081,8888"
      scan_type: "--script http-title,http-headers,http-methods,http-enum"
    dependencies:
      - service_detection

  - name: sql_checks
    type: tool
    tool: nmap
    objective: "SQL service checks (MySQL/MSSQL/Oracle info)"
    parameters:
      ports_from_context: true
      ports_filter: "1433,1521,3306,5432"
      scan_type: "--script ms-sql-info,ms-sql-ntlm-info,mysql-info,oracle-sid-brute"
    dependencies:
      - service_detection

  - name: ssl_tls_scan
    type: tool
    tool: testssl
    objective: "Deep SSL/TLS analysis on HTTPS services"
    parameters:
      severity: "LOW"
    dependencies:
      - service_detection

  - name: nmap_vuln_scan
    type: tool
    tool: nmap
    objective: "Nmap NSE vulnerability scripts on discovered ports"
    parameters:
      profile: "vuln"
      ports_from_context: true
      tool_timeout: 900
    dependencies:
      - service_detection

  - name: vulnerability_assessment
    type: tool
    tool: nuclei
    objective: "Network vulnerability scanning"
    parameters:
      severity: ["critical", "high"]
    dependencies:
      - service_detection

  - name: metasploit_validation
    type: tool
    tool: metasploit
    objective: "Optional Metasploit module execution (if configured)"
    parameters: {}
    condition: config_has:tools.metasploit.module
    dependencies:
      - vulnerability_assessment

  # Active Directory Assessment (requires BloodHound MCP + SharpHound data)
  - name: ad_attack_surface
    type: tool
    tool: bloodhound
    objective: "Analyze AD attack surface statistics"
    parameters:
      tool: get_attack_surface_stats
    condition: config_has:mcp.servers.bloodhound
    dependencies:
      - ldap_enumeration

  - name: ad_paths_to_da
    type: tool
    tool: bloodhound
    objective: "Find attack paths to Domain Admins"
    parameters:
      tool: find_path_to_da
      max_depth: 10
    condition: config_has:mcp.servers.bloodhound
    dependencies:
      - ad_attack_surface

  - name: ad_kerberoastable
    type: tool
    tool: bloodhound
    objective: "Find Kerberoastable users"
    parameters:
      tool: get_kerberoastable_users
    condition: config_has:mcp.servers.bloodhound
    dependencies:
      - ad_attack_surface

  - name: ad_asreproastable
    type: tool
    tool: bloodhound
    objective: "Find AS-REP roastable users"
    parameters:
      tool: get_asreproastable_users
    condition: config_has:mcp.servers.bloodhound
    dependencies:
      - ad_attack_surface

  - name: ad_delegation_issues
    type: tool
    tool: bloodhound
    objective: "Find delegation vulnerabilities"
    parameters:
      tool: get_unconstrained_delegation
    condition: config_has:mcp.servers.bloodhound
    dependencies:
      - ad_attack_surface

  - name: ad_acl_abuse
    type: tool
    tool: bloodhound
    objective: "Find ACL abuse paths"
    parameters:
      tool: get_acl_abuse_paths
    condition: config_has:mcp.servers.bloodhound
    dependencies:
      - ad_attack_surface

  - name: analyze_network
    type: analysis
    agent: analyst
    objective: "Analyze network security posture including AD attack paths"

  - name: generate_network_report
    type: report
    agent: reporter
    format: markdown

settings:
  max_parallel_tools: 1  # Sequential for network scans
  require_confirmation: true
  save_intermediate: true

# Optional: Skip AD assessment
# Run with --skip-ad or set skip_ad: true in workflow parameters
options:
  skip_ad:
    description: "Skip Active Directory assessment (BloodHound)"
    default: false
    skips:
      - ad_attack_surface
      - ad_paths_to_da
      - ad_kerberoastable
      - ad_asreproastable
      - ad_delegation_issues
      - ad_acl_abuse
