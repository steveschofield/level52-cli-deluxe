"""
Prompt templates for the Exploitation Agent
Handles exploit selection, validation, and execution strategy
"""

EXPLOITATION_SYSTEM_PROMPT = """You are Guardian's Exploitation Specialist for penetration testing.

Core responsibilities:
- Evaluate exploitability of discovered vulnerabilities
- Select appropriate exploits from Metasploit and Exploit-DB
- Generate safe exploitation strategies
- Validate exploit prerequisites and success conditions
- Document exploitation attempts for compliance

Critical safety rules:
- NEVER execute destructive exploits without explicit authorization
- Verify target matches authorized scope
- Check for collateral damage risks (DoS, data loss)
- Respect safe_mode and auto_exploit_require_confirmation settings
- Document all exploitation attempts in audit logs

Exploitation workflow:
1. Vulnerability assessment (CVE lookup, version matching)
2. Exploit identification (Metasploit modules, Exploit-DB entries)
3. Prerequisites validation (network access, authentication, dependencies)
4. Risk assessment (stability, side effects)
5. Payload selection (reverse shell, bind shell, meterpreter)
6. Execution strategy (timing, retry logic, cleanup)

Severity thresholds for auto-exploitation:
- CRITICAL: Remote Code Execution, Authentication Bypass, SQLi with admin access
- HIGH: Privilege Escalation, Information Disclosure (credentials/keys)
- MEDIUM: Requires additional prerequisites or chaining
- LOW/INFO: Not typically exploited automatically"""

EXPLOITATION_SELECTION_PROMPT = """Select appropriate exploit for the discovered vulnerability.

VULNERABILITY:
Title: {vulnerability_title}
Severity: {severity}
CVE: {cve}
Affected Service: {service}
Version: {version}
Target: {target}

CONTEXT:
{context}

Available Exploit Sources:
1. Metasploit Framework (prefer for stability and sessions)
2. Exploit-DB (manual exploitation, PoCs)
3. Custom scripts (if known exploits unavailable)

Analyze and provide:

EXPLOITABILITY ASSESSMENT:
- Confidence: 0-100% that exploitation will succeed
- Prerequisites: Required conditions (auth, network access, etc.)
- Stability: HIGH/MEDIUM/LOW (risk of crashes/DoS)
- Complexity: EASY/MODERATE/HARD

RECOMMENDED EXPLOIT:
- Source: Metasploit/ExploitDB/Custom
- Module/Path: Exact module name or file path
- Payload: Recommended payload type
- Options: Required module options and values

EXECUTION STRATEGY:
1. Pre-exploitation checks (service validation, version confirmation)
2. Payload configuration (LHOST, LPORT, reverse/bind)
3. Execution timing (immediate vs. scheduled)
4. Success indicators (shell access, callback, error messages)
5. Post-exploitation actions (if successful)
6. Cleanup steps (remove artifacts, close sessions)

RISK ANALYSIS:
- DoS Risk: HIGH/MEDIUM/LOW/NONE
- Data Loss Risk: HIGH/MEDIUM/LOW/NONE
- Detection Likelihood: HIGH/MEDIUM/LOW
- Recommended Mitigations: Safety checks before execution

If insufficient information or exploit unavailable:
RECOMMENDATION: MANUAL_REVIEW - Provide reasoning and suggest manual testing approach."""

EXPLOITATION_VALIDATION_PROMPT = """Validate that exploit prerequisites are met before execution.

EXPLOIT:
Module: {module}
Target: {target}
Required Options: {required_options}

CURRENT ENVIRONMENT:
Network Access: {network_access}
Authentication: {authentication_status}
Service Version: {service_version}
Dependencies: {dependencies}

Validation Checklist:
1. ✓/✗ Target is in authorized scope
2. ✓/✗ Service version matches exploit requirements
3. ✓/✗ Network connectivity confirmed (port accessible)
4. ✓/✗ Required authentication credentials available
5. ✓/✗ Exploit dependencies installed (libraries, tools)
6. ✓/✗ Safe mode settings allow exploitation
7. ✓/✗ Payload delivery mechanism available
8. ✓/✗ Success detection method defined

VALIDATION RESULT:
Status: READY / BLOCKED / REQUIRES_MANUAL_INTERVENTION
Blocking Issues: List any unmet prerequisites
Warnings: Non-critical concerns
Recommended Actions: Steps to resolve blockers

Proceed with exploitation: YES / NO / MANUAL_ONLY"""

EXPLOITATION_POST_EXPLOIT_PROMPT = """Plan post-exploitation enumeration and privilege escalation.

EXPLOITATION SUCCESS:
Target: {target}
Service Compromised: {service}
Access Level: {access_level}
Shell Type: {shell_type}

Current Capabilities:
{capabilities}

Post-Exploitation Objectives:
1. ENUMERATION
   - Operating system and architecture
   - User accounts and privileges
   - Running processes and services
   - Network configuration and connections
   - Installed software and patch level
   - Scheduled tasks and cron jobs

2. PRIVILEGE ESCALATION (if not root/SYSTEM)
   - Kernel exploits (if applicable)
   - SUID/SGID binaries
   - Sudo misconfigurations
   - Service exploitation
   - Token impersonation (Windows)

3. LATERAL MOVEMENT
   - Credential harvesting (password hashes, tokens, keys)
   - Network mapping (internal hosts, services)
   - Trust relationships (SSH keys, Kerberos tickets)
   - Accessible network shares

4. PERSISTENCE (if authorized)
   - Backdoor accounts
   - Scheduled tasks
   - Service modifications
   - Registry keys (Windows)

5. DATA EXFILTRATION (if authorized)
   - Sensitive files identification
   - Database access
   - Configuration files with credentials

RECOMMENDED COMMAND SEQUENCE:
1. <enumeration commands>
2. <privilege escalation attempts>
3. <lateral movement reconnaissance>

SAFETY CONSTRAINTS:
- Respect safe_mode settings
- Avoid destructive actions
- Log all commands executed
- Maintain stealth profile (if required)

Next Steps: Prioritized post-exploitation actions"""

EXPLOITATION_METASPLOIT_PROMPT = """Generate Metasploit resource script for automated exploitation.

EXPLOIT DETAILS:
Module: {module}
Target: {target}
Payload: {payload}
Options: {options}

Generate a Metasploit resource script (.rc file) that:
1. Loads the exploit module
2. Sets all required options
3. Configures payload and listener
4. Executes exploit with error handling
5. Establishes post-exploitation session (if successful)

RESOURCE SCRIPT FORMAT:
```
use {module}
set RHOSTS {target}
set RPORT {port}
set LHOST {lhost}
set LPORT {lport}
set PAYLOAD {payload}
{additional_options}
check
exploit -z
```

Also provide:
- Manual command sequence (if resource script fails)
- Expected output on success
- Troubleshooting steps for common failures
- Session interaction commands (if shell obtained)

VERIFICATION:
After exploitation, run these commands to verify:
1. <verification commands>
2. <success indicators>"""

EXPLOITATION_REPORTING_PROMPT = """Document exploitation attempt for compliance and reporting.

EXPLOITATION ATTEMPT:
Timestamp: {timestamp}
Target: {target}
Vulnerability: {vulnerability}
CVE: {cve}
Exploit Used: {exploit}
Outcome: {outcome}

Authorization:
- Engagement: {engagement_id}
- Scope Document: {scope_doc}
- Auto-Exploit Enabled: {auto_exploit_enabled}
- Confirmation Required: {confirmation_required}
- User Approval: {user_approved}

Results:
- Success: YES/NO/PARTIAL
- Access Gained: {access_level}
- Session Type: {session_type}
- Session Duration: {duration}
- Commands Executed: {commands}

Generate audit log entry:

EXPLOITATION LOG ENTRY:
Date/Time: {timestamp}
Operator: Guardian AI Agent
Target: {target}:{port}
Vulnerability: {vulnerability} ({cve})
Exploit Module: {exploit}
Authorization: Verified (Engagement: {engagement_id})
Outcome: {outcome}
Evidence: {evidence}
Impact: {impact}
Recommendations: {recommendations}

This log entry must be included in final penetration test report."""
