---
- name: Install Guardian CLI and Configure Automated Security Assessments
  hosts: guardian_workers 
  become: yes
  
  gather_facts: true
  vars:
    username: 52pickup
    guardian_dir: "/home/{{ username }}/level52-cli-deluxe"
    guardian_python_version: "3.13.12"
    # level52-cli-deluxe setup uses `go install pkg@latest` which needs Go >= 1.17.
    # We install a specific version to ensure consistency across environments.
    go_version: "1.22.0"
    go_root: "/home/{{ username }}/.local/go"
    go_path: "/home/{{ username }}/go"
    # Network targets for recon/network scans
    network_targets:
      - "192.168.1.232"
      - "192.168.1.244"
    # Web targets - the vulnerable apps deployed by vulnapps playbook
    web_targets:
      - name: "juice-shop"
        url: "http://localhost:3000"
        description: "OWASP Juice Shop"
      - name: "dvwa"
        url: "http://localhost:4280"
        description: "Damn Vulnerable Web Application"
      - name: "webgoat"
        url: "http://localhost:8080/WebGoat"
        description: "WebGoat Security Lessons"
      - name: "vampi"
        url: "http://localhost:5000"
        description: "Vulnerable API"
      - name: "wrongsecrets"
        url: "http://localhost:8081"
        description: "OWASP WrongSecrets"
      - name: "musashi-js"
        url: "http://localhost:8082"
        description: "Musashi JavaScript Challenges"
      - name: "vuln-bank"
        url: "http://localhost:5001"
        description: "Vulnerable Banking App"
      - name: "security-shepherd"
        url: "http://localhost:8083"
        description: "OWASP Security Shepherd"
      - name: "nodegoat"
        url: "http://localhost:4000"
        description: "NodeGoat OWASP Top 10"

  tasks:
    - name: Remove unsupported Trivy apt repo on Kali
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/trivy.list
        state: absent
      when: ansible_distribution | lower == "kali"

    - name: Remove stale Trivy apt keyring on Kali
      ansible.builtin.file:
        path: /usr/share/keyrings/trivy.gpg
        state: absent
      when: ansible_distribution | lower == "kali"

    # ===========================================
    # Install Guardian CLI Dependencies
    # ===========================================
    - name: Install system dependencies for Guardian CLI
      apt:
        name:
          - git
          - python3
          - python3-pip
          - python3-venv
          - ca-certificates
          # Scanning & recon tools
          - nmap
          - nikto
          - sqlmap
          - dirb
          - gobuster
          - whatweb
          - dnsutils
          - whois
          - curl
          - jq
          - bc
          # Network/enumeration tools
          - masscan
          - hydra
          - smbclient
          - nfs-common
          - snmp
          - onesixtyone
          - libpcap-dev
          - libcap2-bin
          # Ruby (for wpscan)
          - ruby
          - ruby-dev
          # Node.js (for retire.js)
          - nodejs
          - npm
        state: present
        update_cache: true

    - name: Install enum4linux (if available)
      apt:
        name: enum4linux
        state: present
      register: enum4linux_install
      failed_when: false

    - name: Install amass (if available)
      apt:
        name: amass
        state: present
      register: amass_install
      failed_when: false

    - name: Install seclists (if available)
      apt:
        name: seclists
        state: present
      register: seclists_install
      failed_when: false

    # -----------------------------------------
    # Metasploit Framework (official Rapid7 repo)
    # -----------------------------------------
    - name: Download Rapid7 Metasploit signing key
      ansible.builtin.command:
        argv:
          - /bin/bash
          - -lc
          - "curl -fsSL https://apt.metasploit.com/metasploit-framework.gpg.key | gpg --dearmor -o /usr/share/keyrings/metasploit-framework.gpg"
        creates: /usr/share/keyrings/metasploit-framework.gpg
      failed_when: false

    - name: Add Metasploit APT repository
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/metasploit-framework.list
        content: "deb [signed-by=/usr/share/keyrings/metasploit-framework.gpg] https://apt.metasploit.com/ lucid main\n"
        mode: "0644"
      failed_when: false

    - name: Install Metasploit Framework
      apt:
        name: metasploit-framework
        state: present
        update_cache: true
      register: metasploit_install
      failed_when: false

    - name: Map Go architecture for download
      ansible.builtin.set_fact:
        go_arch: >-
          {{ 'amd64' if ansible_architecture in ['x86_64', 'amd64'] else
             'arm64' if ansible_architecture in ['aarch64', 'arm64'] else
             ansible_architecture }}

    - name: Download Go {{ go_version }}
      ansible.builtin.get_url:
        url: "https://go.dev/dl/go{{ go_version }}.linux-{{ go_arch }}.tar.gz"
        dest: "/tmp/go{{ go_version }}.linux-{{ go_arch }}.tar.gz"
        mode: "0644"

    - name: Detect old Go toolchain installed in GOPATH location
      ansible.builtin.stat:
        path: "{{ go_path }}/VERSION"
      register: gopath_contains_go_toolchain
      become: yes
      become_user: "{{ username }}"

    - name: Remove old Go toolchain from GOPATH location (if present)
      ansible.builtin.file:
        path: "{{ go_path }}"
        state: absent
      become: yes
      become_user: "{{ username }}"
      when: gopath_contains_go_toolchain.stat.exists

    - name: Ensure GOPATH directory exists
      ansible.builtin.file:
        path: "{{ go_path }}"
        state: directory
        mode: "0755"
      become: yes
      become_user: "{{ username }}"

    - name: Remove existing user-local Go toolchain dir
      ansible.builtin.file:
        path: "{{ go_root }}"
        state: absent
      become: yes
      become_user: "{{ username }}"

    - name: Ensure ~/.local exists for user-local installs
      ansible.builtin.file:
        path: "/home/{{ username }}/.local"
        state: directory
        mode: "0755"
      become: yes
      become_user: "{{ username }}"

    - name: Install Go {{ go_version }} under {{ go_root }}
      ansible.builtin.unarchive:
        src: "/tmp/go{{ go_version }}.linux-{{ go_arch }}.tar.gz"
        dest: "/home/{{ username }}/.local"
        remote_src: yes
      become: yes
      become_user: "{{ username }}"

    - name: Ensure user-local Go and GOPATH are on PATH in .profile
      ansible.builtin.blockinfile:
        path: "/home/{{ username }}/.profile"
        block: |
          # Go toolchain + GOPATH (installed by Ansible)
          export GOROOT="$HOME/.local/go"
          export GOPATH="$HOME/go"
          export PATH="$GOROOT/bin:$GOPATH/bin:$PATH"
        marker: "# {mark} ANSIBLE MANAGED GO"
        create: yes
      become: yes
      become_user: "{{ username }}"

    - name: Install optional wpscan package (if available)
      apt:
        name: wpscan
        state: present
      register: wpscan_install
      failed_when: false
      changed_when: "'No package matching' not in (wpscan_install.msg | default(''))"

    - name: Warn when wpscan package is unavailable
      ansible.builtin.debug:
        msg: "Optional package 'wpscan' is not available on this distro; continuing without it."
      when: "'No package matching' in (wpscan_install.msg | default(''))"

    # ===========================================
    # Clone Guardian CLI Repository
    # ===========================================
    - name: Clone level52-cli-deluxe repository
      ansible.builtin.git:
        repo: https://github.com/steveschofield/level52-cli-deluxe.git
        dest: "{{ guardian_dir }}"
        force: yes
      become_user: "{{ username }}"

    - name: Install Python {{ guardian_python_version }} via pyenv
      ansible.builtin.command:
        argv:
          - /bin/bash
          - -lc
          - |
            export PYENV_ROOT="$HOME/.pyenv"
            export PATH="$PYENV_ROOT/bin:$PATH"
            eval "$(pyenv init --path)"
            pyenv install -s {{ guardian_python_version }}
      become_user: "{{ username }}"

    - name: Remove existing Guardian virtual environment
      ansible.builtin.file:
        path: "{{ guardian_dir }}/venv"
        state: absent
      become_user: "{{ username }}"

    - name: Create Python {{ guardian_python_version }} virtual environment for Guardian
      ansible.builtin.command:
        argv:
          - /bin/bash
          - -lc
          - |
            export PYENV_ROOT="$HOME/.pyenv"
            "$PYENV_ROOT/versions/{{ guardian_python_version }}/bin/python" -m venv {{ guardian_dir }}/venv
      become_user: "{{ username }}"

    - name: Verify venv Python version is {{ guardian_python_version }}
      ansible.builtin.command:
        argv:
          - /bin/bash
          - -lc
          - |
            VER=$({{ guardian_dir }}/venv/bin/python --version 2>&1)
            echo "$VER"
            echo "$VER" | grep -q "{{ guardian_python_version }}" || { echo "FAIL: expected {{ guardian_python_version }}"; exit 1; }
      become_user: "{{ username }}"
      register: venv_python_version
      changed_when: false

    - name: Display venv Python version
      ansible.builtin.debug:
        msg: "Guardian venv Python version: {{ venv_python_version.stdout }}"

    - name: Ensure pip exists in Guardian venv
      ansible.builtin.command:
        argv:
          - /bin/bash
          - -lc
          - "cd {{ guardian_dir }} && ./venv/bin/python -m ensurepip --upgrade && ./venv/bin/python -m pip install --upgrade pip setuptools wheel"
      become_user: "{{ username }}"

    - name: Write .python-version file for pyenv compatibility
      ansible.builtin.copy:
        content: "{{ guardian_python_version }}"
        dest: "{{ guardian_dir }}/.python-version"
        owner: "{{ username }}"
        mode: "0644"

    - name: Check for Guardian setup script
      ansible.builtin.stat:
        path: "{{ guardian_dir }}/setup.sh"
      register: guardian_setup_script

    - name: Run Guardian setup script (with Go and pyenv on PATH)
      ansible.builtin.command:
        argv:
          - /bin/bash
          - -lc
          - |
            export PYENV_ROOT="$HOME/.pyenv"
            export PATH="$PYENV_ROOT/bin:$PATH"
            eval "$(pyenv init --path)"
            export GOROOT="$HOME/.local/go"
            export GOPATH="$HOME/go"
            export PATH="$GOROOT/bin:$GOPATH/bin:$PATH"
            cd {{ guardian_dir }}
            source venv/bin/activate
            chmod +x setup.sh
            ./setup.sh 2>&1 | tee setup.log
      become_user: "{{ username }}"
      when: guardian_setup_script.stat.exists
      timeout: 1800

    - name: Check for Guardian requirements.txt
      ansible.builtin.stat:
        path: "{{ guardian_dir }}/requirements.txt"
      register: guardian_requirements_file

    - name: Install Guardian Python dependencies from requirements.txt
      ansible.builtin.command:
        argv:
          - /bin/bash
          - -lc
          - "cd {{ guardian_dir }} && ./venv/bin/python -m pip install -r requirements.txt"
      become_user: "{{ username }}"
      when: guardian_requirements_file.stat.exists

    - name: Fail when setup.sh is missing
      ansible.builtin.fail:
        msg: "Expected {{ guardian_dir }}/setup.sh, but it was not found."
      when: not guardian_setup_script.stat.exists

    # ===========================================
    # Post-setup: Docker images & system config
    # ===========================================
    - name: Pull BloodHound Docker image
      ansible.builtin.command:
        argv:
          - docker
          - pull
          - ghcr.io/fuzzinglabs/bloodhound-mcp:latest
      become_user: "{{ username }}"
      failed_when: false

    - name: Pull ZAP Docker image (if not already present)
      ansible.builtin.command:
        argv:
          - docker
          - pull
          - ghcr.io/zaproxy/zaproxy:stable
      become_user: "{{ username }}"
      failed_when: false

    # -----------------------------------------
    # Exploit-DB / SearchSploit
    # -----------------------------------------
    - name: Clone Exploit-DB repository
      ansible.builtin.git:
        repo: https://gitlab.com/exploit-database/exploitdb.git
        dest: "/opt/exploitdb"
        depth: 1
        force: yes
      register: exploitdb_clone
      failed_when: false

    - name: Symlink searchsploit into PATH
      ansible.builtin.file:
        src: /opt/exploitdb/searchsploit
        dest: /usr/local/bin/searchsploit
        state: link
      when: exploitdb_clone is not failed

    - name: Create searchsploit config directory
      ansible.builtin.file:
        path: "/home/{{ username }}/.searchsploit_rc"
        state: absent
      when: exploitdb_clone is not failed

    - name: Configure searchsploit rc file
      ansible.builtin.copy:
        dest: "/home/{{ username }}/.searchsploit_rc"
        owner: "{{ username }}"
        mode: "0644"
        content: |
          package_array+=(EXPLOITDB "/opt/exploitdb")
          package_array+=(EXPLOITDB_PAPERS "/opt/exploitdb/exploits")
      when: exploitdb_clone is not failed

    - name: Detect masscan binary path
      ansible.builtin.command:
        argv:
          - /bin/bash
          - -lc
          - "command -v masscan"
      register: masscan_bin
      changed_when: false
      failed_when: false

    - name: Set masscan network capabilities for non-root use
      ansible.builtin.command:
        argv:
          - setcap
          - cap_net_raw,cap_net_admin+eip
          - "{{ masscan_bin.stdout }}"
      when: masscan_bin.rc == 0 and (masscan_bin.stdout | length > 0)
      failed_when: false

    # ===========================================
    # Create Guardian Configuration
    # ===========================================
    - name: Create Guardian config directory
      ansible.builtin.file:
        path: "/home/{{ username }}/.guardian"
        state: directory
        owner: "{{ username }}"
        mode: "0755"

    - name: Create Guardian reports directory
      ansible.builtin.file:
        path: "{{ guardian_dir }}/reports"
        state: directory
        owner: "{{ username }}"
        mode: "0755"

    - name: Create Guardian logs directory
      ansible.builtin.file:
        path: "{{ guardian_dir }}/logs"
        state: directory
        owner: "{{ username }}"
        mode: "0755"

    # ===========================================
    # Create Lab Assessment Script
    # ===========================================
    - name: Create guardian-lab-assess script
      ansible.builtin.copy:
        dest: /usr/local/bin/guardian-lab-assess
        mode: "0755"
        content: |
          #!/bin/bash
          # Guardian Lab Assessment Script
          # Automated security testing for the ethical hacking lab
          #
          # Usage:
          #   guardian-lab-assess [mode] [options]
          #
          # Modes:
          #   recon       - Run reconnaissance against network targets
          #   network     - Run network penetration testing
          #   web         - Run web application testing against vuln apps
          #   autonomous  - Run AI-driven autonomous testing
          #   all         - Run all assessments
          #   list        - List available targets
          #   status      - Show status of running assessments

          GUARDIAN_DIR="{{ guardian_dir }}"
          VENV_ACTIVATE="$GUARDIAN_DIR/venv/bin/activate"
          REPORTS_DIR="$GUARDIAN_DIR/reports"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # Network targets
          NETWORK_TARGETS=(
          {% for target in network_targets %}
              "{{ target }}"
          {% endfor %}
          )

          # Web targets (vulnerable apps)
          declare -A WEB_TARGETS=(
          {% for app in web_targets %}
              ["{{ app.name }}"]="{{ app.url }}"
          {% endfor %}
          )

          declare -A WEB_DESCRIPTIONS=(
          {% for app in web_targets %}
              ["{{ app.name }}"]="{{ app.description }}"
          {% endfor %}
          )

          # Colors
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          CYAN='\033[0;36m'
          NC='\033[0m'

          log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
          log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
          log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
          log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
          log_header() { echo -e "\n${CYAN}========== $1 ==========${NC}\n"; }

          activate_venv() {
              if [ -f "$VENV_ACTIVATE" ]; then
                  source "$VENV_ACTIVATE"
              else
                  log_error "Guardian virtual environment not found at $VENV_ACTIVATE"
                  exit 1
              fi
          }

          run_guardian() {
              local workflow="$1"
              local target="$2"
              local extra_args="${3:-}"

              cd "$GUARDIAN_DIR"
              # Avoid relying on shell/python shims; use the venv interpreter explicitly.
              activate_venv

              log_info "Running Guardian workflow: $workflow against $target"
              "$GUARDIAN_DIR/venv/bin/python" -m cli.main workflow run --name "$workflow" --target "$target" $extra_args
          }

          list_targets() {
              log_header "Available Targets"

              echo -e "${YELLOW}Network Targets (for recon/network scans):${NC}"
              for target in "${NETWORK_TARGETS[@]}"; do
                  echo "  - $target"
              done

              echo -e "\n${YELLOW}Web Targets (vulnerable applications):${NC}"
              printf "  %-20s %-35s %s\n" "NAME" "URL" "DESCRIPTION"
              printf "  %-20s %-35s %s\n" "----" "---" "-----------"
              for app in "${!WEB_TARGETS[@]}"; do
                  printf "  %-20s %-35s %s\n" "$app" "${WEB_TARGETS[$app]}" "${WEB_DESCRIPTIONS[$app]}"
              done
          }

          run_recon() {
              log_header "Running Reconnaissance"

              for target in "${NETWORK_TARGETS[@]}"; do
                  log_info "Recon scan: $target"
                  run_guardian "recon" "$target" "--auto-exploit"
                  log_success "Completed recon for $target"
              done
          }

          run_network() {
              log_header "Running Network Penetration Testing"

              for target in "${NETWORK_TARGETS[@]}"; do
                  log_info "Network scan: $target"
                  run_guardian "network" "$target" "--auto-exploit"
                  log_success "Completed network scan for $target"
              done
          }

          run_web() {
              log_header "Running Web Application Testing"

              local app_filter="$1"

              for app in "${!WEB_TARGETS[@]}"; do
                  # If filter specified, only run matching app
                  if [ -n "$app_filter" ] && [ "$app" != "$app_filter" ]; then
                      continue
                  fi

                  url="${WEB_TARGETS[$app]}"
                  desc="${WEB_DESCRIPTIONS[$app]}"

                  log_info "Web scan: $app ($desc)"
                  log_info "Target URL: $url"

                  # Check if the app is running
                  if curl -s -o /dev/null -w "%{http_code}" "$url" | grep -q "200\|302\|301\|401\|403"; then
                      run_guardian "web" "$url" "--auto-exploit"
                      log_success "Completed web scan for $app"
                  else
                      log_warn "Skipping $app - not responding at $url"
                      log_warn "Try: vuln-apps start"
                  fi
              done
          }

          run_autonomous() {
              log_header "Running Autonomous AI-Driven Testing"

              local target_type="$1"

              case "$target_type" in
                  network)
                      for target in "${NETWORK_TARGETS[@]}"; do
                          log_info "Autonomous scan (network): $target"
                          run_guardian "autonomous" "$target" "--auto-exploit --auto-exploit-no-confirm"
                      done
                      ;;
                  web|"")
                      for app in "${!WEB_TARGETS[@]}"; do
                          url="${WEB_TARGETS[$app]}"
                          if curl -s -o /dev/null -w "%{http_code}" "$url" | grep -q "200\|302\|301\|401\|403"; then
                              log_info "Autonomous scan (web): $app"
                              run_guardian "autonomous" "$url" "--auto-exploit --auto-exploit-no-confirm"
                          fi
                      done
                      ;;
                  *)
                      log_info "Autonomous scan: $target_type"
                      run_guardian "autonomous" "$target_type" "--auto-exploit --auto-exploit-no-confirm"
                      ;;
              esac
          }

          run_all() {
              log_header "Running Complete Lab Assessment"

              log_info "Starting full assessment at $(date)"

              run_recon
              run_network
              run_web
              run_autonomous "web"

              log_success "Full assessment completed at $(date)"
              log_info "Reports available in: $REPORTS_DIR"
          }

          show_status() {
              log_header "Assessment Status"

              # Check if guardian processes are running
              if pgrep -f "guardian" > /dev/null; then
                  log_info "Guardian processes running:"
                  ps aux | grep -E "guardian|cli.main" | grep -v grep
              else
                  log_info "No Guardian assessments currently running"
              fi

              # Show recent reports
              echo -e "\n${YELLOW}Recent Reports:${NC}"
              ls -lt "$REPORTS_DIR"/*.md 2>/dev/null | head -10 || echo "  No reports found"
          }

          show_help() {
              echo -e "${CYAN}Guardian Lab Assessment Script${NC}"
              echo -e "Automated security testing for the ethical hacking lab\n"
              echo "Usage: guardian-lab-assess <mode> [options]"
              echo ""
              echo "Modes:"
              echo "  recon              Run reconnaissance against network targets"
              echo "  network            Run network penetration testing"
              echo "  web [app-name]     Run web app testing (optionally specify single app)"
              echo "  autonomous [type]  Run AI-driven autonomous testing (network|web|<target>)"
              echo "  all                Run all assessments"
              echo "  list               List all available targets"
              echo "  status             Show status of running assessments"
              echo "  help               Show this help message"
              echo ""
              echo "Examples:"
              echo "  guardian-lab-assess list                    # Show all targets"
              echo "  guardian-lab-assess recon                   # Scan network targets"
              echo "  guardian-lab-assess web                     # Test all web apps"
              echo "  guardian-lab-assess web juice-shop          # Test only Juice Shop"
              echo "  guardian-lab-assess autonomous web          # AI-driven web testing"
              echo "  guardian-lab-assess all                     # Run everything"
              echo ""
              echo "Network Targets: ${NETWORK_TARGETS[*]}"
              echo "Web Apps: ${!WEB_TARGETS[*]}"
              echo ""
              echo "Reports saved to: $REPORTS_DIR"
          }

          # Main
          case "${1:-help}" in
              recon)      run_recon ;;
              network)    run_network ;;
              web)        run_web "$2" ;;
              autonomous) run_autonomous "$2" ;;
              all)        run_all ;;
              list)       list_targets ;;
              status)     show_status ;;
              help|*)     show_help ;;
          esac

    # ===========================================
    # Create Quick Scan Aliases
    # ===========================================
    - name: Add Guardian aliases and auto-activate venv to user bashrc
      ansible.builtin.blockinfile:
        path: "/home/{{ username }}/.bashrc"
        block: |
          # Guardian virtual environment auto-activation
          # Activate when logging in or when cd'ing into the guardian directory
          GUARDIAN_VENV="{{ guardian_dir }}/venv/bin/activate"

          # Auto-activate on cd into level52-cli-deluxe (or any subdirectory)
          guardian_auto_venv() {
              builtin cd "$@" || return
              if [[ "$PWD" == {{ guardian_dir }}* ]] && [[ -f "$GUARDIAN_VENV" ]]; then
                  if [[ -z "$VIRTUAL_ENV" || "$VIRTUAL_ENV" != "{{ guardian_dir }}/venv" ]]; then
                      source "$GUARDIAN_VENV"
                  fi
              elif [[ -n "$VIRTUAL_ENV" && "$VIRTUAL_ENV" == "{{ guardian_dir }}/venv" ]]; then
                  deactivate
              fi
          }
          alias cd='guardian_auto_venv'

          # Also activate on login if we start in or navigate to the guardian dir
          if [[ "$PWD" == {{ guardian_dir }}* ]] && [[ -f "$GUARDIAN_VENV" ]]; then
              source "$GUARDIAN_VENV"
          fi

          # Guardian CLI aliases
          alias guardian='cd {{ guardian_dir }} && ./venv/bin/python -m cli.main'
          alias guardian-recon='guardian-lab-assess recon'
          alias guardian-network='guardian-lab-assess network'
          alias guardian-web='guardian-lab-assess web'
          alias guardian-auto='guardian-lab-assess autonomous'
          alias guardian-all='guardian-lab-assess all'
          alias guardian-status='guardian-lab-assess status'

          # Quick scans
          alias scan-juice='guardian-lab-assess web juice-shop'
          alias scan-dvwa='guardian-lab-assess web dvwa'
          alias scan-webgoat='guardian-lab-assess web webgoat'
          alias scan-vampi='guardian-lab-assess web vampi'
        marker: "# {mark} GUARDIAN CLI ALIASES"
        create: yes
        owner: "{{ username }}"

    # ===========================================
    # Create Scheduled Assessment (Optional)
    # ===========================================
    - name: Create systemd service for scheduled assessments
      ansible.builtin.copy:
        dest: /etc/systemd/system/guardian-assessment.service
        mode: "0644"
        content: |
          [Unit]
          Description=Guardian Security Assessment
          After=docker.service
          Requires=docker.service

          [Service]
          Type=oneshot
          User={{ username }}
          ExecStart=/usr/local/bin/guardian-lab-assess all
          StandardOutput=append:/var/log/guardian-assessment.log
          StandardError=append:/var/log/guardian-assessment.log

          [Install]
          WantedBy=multi-user.target

    - name: Create systemd timer for scheduled assessments
      ansible.builtin.copy:
        dest: /etc/systemd/system/guardian-assessment.timer
        mode: "0644"
        content: |
          [Unit]
          Description=Run Guardian Assessment Weekly

          [Timer]
          OnCalendar=weekly
          Persistent=true

          [Install]
          WantedBy=timers.target

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: yes

    # Note: Timer is created but not enabled by default
    # Enable with: sudo systemctl enable --now guardian-assessment.timer

    # ===========================================
    # Final Status Message
    # ===========================================
    - name: Display Guardian installation message
      ansible.builtin.debug:
        msg: |

          ============================================
          Guardian CLI Installed Successfully!
          ============================================

          Guardian CLI Location: {{ guardian_dir }}

          Quick Commands:
            guardian-lab-assess list       # Show all targets
            guardian-lab-assess recon      # Reconnaissance scans
            guardian-lab-assess network    # Network penetration testing
            guardian-lab-assess web        # Web app security testing
            guardian-lab-assess autonomous # AI-driven testing
            guardian-lab-assess all        # Run all assessments

          Network Targets:
          {% for target in network_targets %}
            - {{ target }}
          {% endfor %}

          Web Targets (Vulnerable Apps):
          {% for app in web_targets %}
            - {{ app.name }}: {{ app.url }}
          {% endfor %}

          Aliases (after re-login):
            guardian          # Activate Guardian CLI
            scan-juice        # Quick scan Juice Shop
            scan-dvwa         # Quick scan DVWA
            scan-webgoat      # Quick scan WebGoat
            scan-vampi        # Quick scan VAmPI

          Optional: Enable weekly scheduled assessments:
            sudo systemctl enable --now guardian-assessment.timer

          ============================================
