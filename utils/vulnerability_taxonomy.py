"""
Vulnerability taxonomy and CWE/OWASP auto-mapping.
"""

from dataclasses import dataclass
from typing import Dict, List, Optional

from utils.logger import get_logger


@dataclass(frozen=True)
class VulnerabilityMapping:
    """Mapping of vulnerability to CWE and OWASP."""
    cwe_ids: List[str]
    owasp_categories: List[str]
    severity_guidance: str
    description: str


class VulnerabilityTaxonomy:
    """Vulnerability taxonomy with CWE and OWASP Top 10 mappings."""

    VULN_MAPPINGS: Dict[str, VulnerabilityMapping] = {
        "sql injection": VulnerabilityMapping(
            cwe_ids=["CWE-89"],
            owasp_categories=["A03:2021 - Injection"],
            severity_guidance="critical",
            description="SQL Injection vulnerability",
        ),
        "sqli": VulnerabilityMapping(
            cwe_ids=["CWE-89"],
            owasp_categories=["A03:2021 - Injection"],
            severity_guidance="critical",
            description="SQL Injection vulnerability",
        ),
        "command injection": VulnerabilityMapping(
            cwe_ids=["CWE-77", "CWE-78"],
            owasp_categories=["A03:2021 - Injection"],
            severity_guidance="critical",
            description="OS Command Injection",
        ),
        "ldap injection": VulnerabilityMapping(
            cwe_ids=["CWE-90"],
            owasp_categories=["A03:2021 - Injection"],
            severity_guidance="high",
            description="LDAP Injection",
        ),
        "xml injection": VulnerabilityMapping(
            cwe_ids=["CWE-91"],
            owasp_categories=["A03:2021 - Injection"],
            severity_guidance="high",
            description="XML Injection",
        ),
        "cross-site scripting": VulnerabilityMapping(
            cwe_ids=["CWE-79"],
            owasp_categories=["A03:2021 - Injection"],
            severity_guidance="high",
            description="Cross-Site Scripting (XSS)",
        ),
        "xss": VulnerabilityMapping(
            cwe_ids=["CWE-79"],
            owasp_categories=["A03:2021 - Injection"],
            severity_guidance="high",
            description="Cross-Site Scripting (XSS)",
        ),
        "reflected xss": VulnerabilityMapping(
            cwe_ids=["CWE-79"],
            owasp_categories=["A03:2021 - Injection"],
            severity_guidance="high",
            description="Reflected Cross-Site Scripting",
        ),
        "stored xss": VulnerabilityMapping(
            cwe_ids=["CWE-79"],
            owasp_categories=["A03:2021 - Injection"],
            severity_guidance="critical",
            description="Stored Cross-Site Scripting",
        ),
        "dom xss": VulnerabilityMapping(
            cwe_ids=["CWE-79"],
            owasp_categories=["A03:2021 - Injection"],
            severity_guidance="high",
            description="DOM-based Cross-Site Scripting",
        ),
        "broken authentication": VulnerabilityMapping(
            cwe_ids=["CWE-287"],
            owasp_categories=["A07:2021 - Identification and Authentication Failures"],
            severity_guidance="critical",
            description="Broken Authentication",
        ),
        "weak password": VulnerabilityMapping(
            cwe_ids=["CWE-521"],
            owasp_categories=["A07:2021 - Identification and Authentication Failures"],
            severity_guidance="high",
            description="Weak Password Requirements",
        ),
        "session fixation": VulnerabilityMapping(
            cwe_ids=["CWE-384"],
            owasp_categories=["A07:2021 - Identification and Authentication Failures"],
            severity_guidance="high",
            description="Session Fixation",
        ),
        "session hijacking": VulnerabilityMapping(
            cwe_ids=["CWE-384"],
            owasp_categories=["A07:2021 - Identification and Authentication Failures"],
            severity_guidance="critical",
            description="Session Hijacking",
        ),
        "broken access control": VulnerabilityMapping(
            cwe_ids=["CWE-284"],
            owasp_categories=["A01:2021 - Broken Access Control"],
            severity_guidance="critical",
            description="Broken Access Control",
        ),
        "idor": VulnerabilityMapping(
            cwe_ids=["CWE-639"],
            owasp_categories=["A01:2021 - Broken Access Control"],
            severity_guidance="high",
            description="Insecure Direct Object Reference",
        ),
        "privilege escalation": VulnerabilityMapping(
            cwe_ids=["CWE-269"],
            owasp_categories=["A01:2021 - Broken Access Control"],
            severity_guidance="critical",
            description="Privilege Escalation",
        ),
        "path traversal": VulnerabilityMapping(
            cwe_ids=["CWE-22"],
            owasp_categories=["A01:2021 - Broken Access Control"],
            severity_guidance="high",
            description="Path Traversal",
        ),
        "directory traversal": VulnerabilityMapping(
            cwe_ids=["CWE-22"],
            owasp_categories=["A01:2021 - Broken Access Control"],
            severity_guidance="high",
            description="Directory Traversal",
        ),
        "cross-site request forgery": VulnerabilityMapping(
            cwe_ids=["CWE-352"],
            owasp_categories=["A01:2021 - Broken Access Control"],
            severity_guidance="high",
            description="Cross-Site Request Forgery (CSRF)",
        ),
        "csrf": VulnerabilityMapping(
            cwe_ids=["CWE-352"],
            owasp_categories=["A01:2021 - Broken Access Control"],
            severity_guidance="high",
            description="Cross-Site Request Forgery (CSRF)",
        ),
        "weak encryption": VulnerabilityMapping(
            cwe_ids=["CWE-327"],
            owasp_categories=["A02:2021 - Cryptographic Failures"],
            severity_guidance="high",
            description="Use of Weak Cryptographic Algorithm",
        ),
        "insecure ssl": VulnerabilityMapping(
            cwe_ids=["CWE-326"],
            owasp_categories=["A02:2021 - Cryptographic Failures"],
            severity_guidance="high",
            description="Inadequate Encryption Strength",
        ),
        "insecure tls": VulnerabilityMapping(
            cwe_ids=["CWE-326"],
            owasp_categories=["A02:2021 - Cryptographic Failures"],
            severity_guidance="high",
            description="Inadequate Encryption Strength",
        ),
        "sensitive data exposure": VulnerabilityMapping(
            cwe_ids=["CWE-311"],
            owasp_categories=["A02:2021 - Cryptographic Failures"],
            severity_guidance="high",
            description="Sensitive Data Exposure",
        ),
        "security misconfiguration": VulnerabilityMapping(
            cwe_ids=["CWE-16"],
            owasp_categories=["A05:2021 - Security Misconfiguration"],
            severity_guidance="medium",
            description="Security Misconfiguration",
        ),
        "default credentials": VulnerabilityMapping(
            cwe_ids=["CWE-798"],
            owasp_categories=["A05:2021 - Security Misconfiguration"],
            severity_guidance="critical",
            description="Use of Hard-coded Credentials",
        ),
        "information disclosure": VulnerabilityMapping(
            cwe_ids=["CWE-200"],
            owasp_categories=["A05:2021 - Security Misconfiguration"],
            severity_guidance="medium",
            description="Information Disclosure",
        ),
        "verbose error": VulnerabilityMapping(
            cwe_ids=["CWE-209"],
            owasp_categories=["A05:2021 - Security Misconfiguration"],
            severity_guidance="low",
            description="Information Exposure Through Error Messages",
        ),
        "xml external entity": VulnerabilityMapping(
            cwe_ids=["CWE-611"],
            owasp_categories=["A05:2021 - Security Misconfiguration"],
            severity_guidance="critical",
            description="XML External Entity (XXE)",
        ),
        "xxe": VulnerabilityMapping(
            cwe_ids=["CWE-611"],
            owasp_categories=["A05:2021 - Security Misconfiguration"],
            severity_guidance="critical",
            description="XML External Entity (XXE)",
        ),
        "insecure deserialization": VulnerabilityMapping(
            cwe_ids=["CWE-502"],
            owasp_categories=["A08:2021 - Software and Data Integrity Failures"],
            severity_guidance="critical",
            description="Insecure Deserialization",
        ),
        "vulnerable component": VulnerabilityMapping(
            cwe_ids=["CWE-1035"],
            owasp_categories=["A06:2021 - Vulnerable and Outdated Components"],
            severity_guidance="high",
            description="Using Components with Known Vulnerabilities",
        ),
        "outdated software": VulnerabilityMapping(
            cwe_ids=["CWE-1104"],
            owasp_categories=["A06:2021 - Vulnerable and Outdated Components"],
            severity_guidance="medium",
            description="Use of Unmaintained Third Party Components",
        ),
        "server-side request forgery": VulnerabilityMapping(
            cwe_ids=["CWE-918"],
            owasp_categories=["A10:2021 - Server-Side Request Forgery (SSRF)"],
            severity_guidance="high",
            description="Server-Side Request Forgery (SSRF)",
        ),
        "ssrf": VulnerabilityMapping(
            cwe_ids=["CWE-918"],
            owasp_categories=["A10:2021 - Server-Side Request Forgery (SSRF)"],
            severity_guidance="high",
            description="Server-Side Request Forgery (SSRF)",
        ),
        "unrestricted file upload": VulnerabilityMapping(
            cwe_ids=["CWE-434"],
            owasp_categories=["A04:2021 - Insecure Design"],
            severity_guidance="critical",
            description="Unrestricted Upload of File with Dangerous Type",
        ),
        "cors misconfiguration": VulnerabilityMapping(
            cwe_ids=["CWE-942"],
            owasp_categories=["A05:2021 - Security Misconfiguration"],
            severity_guidance="medium",
            description="CORS Misconfiguration",
        ),
        "clickjacking": VulnerabilityMapping(
            cwe_ids=["CWE-1021"],
            owasp_categories=["A04:2021 - Insecure Design"],
            severity_guidance="medium",
            description="Clickjacking",
        ),
        "open redirect": VulnerabilityMapping(
            cwe_ids=["CWE-601"],
            owasp_categories=["A01:2021 - Broken Access Control"],
            severity_guidance="medium",
            description="URL Redirection to Untrusted Site",
        ),
    }

    def __init__(self, config: Dict | None = None):
        self.config = config or {}
        self.mappings = self.VULN_MAPPINGS
        self.logger = get_logger(self.config)

    def enrich_finding(self, finding) -> object:
        """Enrich a finding with CWE and OWASP categories when missing."""
        if not finding:
            return finding

        has_cwe = bool(getattr(finding, "cwe_ids", []))
        has_owasp = bool(getattr(finding, "owasp_categories", []))
        if has_cwe and has_owasp:
            return finding

        mapping = self._find_mapping(getattr(finding, "title", ""), getattr(finding, "description", ""))
        if not mapping:
            return finding

        if not has_cwe:
            finding.cwe_ids = list(mapping.cwe_ids)
        if not has_owasp:
            finding.owasp_categories = list(mapping.owasp_categories)

        metadata = getattr(finding, "metadata", None)
        if isinstance(metadata, dict):
            metadata["auto_mapped"] = True
            metadata["mapping_confidence"] = "high"

        return finding

    def _find_mapping(self, title: str, description: str = "") -> Optional[VulnerabilityMapping]:
        title_lower = (title or "").lower()
        desc_lower = (description or "").lower()

        if title_lower in self.mappings:
            return self.mappings[title_lower]

        for pattern, mapping in self.mappings.items():
            if pattern in title_lower or pattern in desc_lower:
                return mapping

        return None

    def get_severity_guidance(self, title: str) -> Optional[str]:
        mapping = self._find_mapping(title)
        return mapping.severity_guidance if mapping else None
